app-id: io.github.hydrusnetwork.hydrus
runtime: org.kde.Platform
runtime-version: '6.6'
sdk: org.kde.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
  - org.freedesktop.Sdk.Extension.llvm16
base: com.riverbankcomputing.PyQt.BaseApp
base-version: '6.6'
add-build-extensions:
  org.freedesktop.Platform.ffmpeg-full:
    directory: lib/ffmpeg
    add-ld-path: .
    no-autodownload: true
    version: '23.08'
command: hydrus_client
cleanup-commands:
  - /app/cleanup-BaseApp.sh
  - mkdir -p ${FLATPAK_DEST}/lib/ffmpeg
build-options:
  env:
    - BASEAPP_REMOVE_WEBENGINE=1
finish-args:
  - --socket=wayland
  - --socket=fallback-x11
  - --socket=pulseaudio
  - --share=ipc
  - --share=network
  - --device=dri
  - --filesystem=home
  - --talk-name=org.kde.StatusNotifierWatcher
cleanup:
  - '*.a'
  - '*.la'
  - /include
  - /etc
  - /man
  - /lib/cmake
  - /lib/pkgconfig
  - /lib/metatypes
  - /share/bash-completion
  - /share/doc
  - /share/man
  - /share/zsh
modules:
  - name: mpv
    buildsystem: meson
    config-opts:
      - -Dbuild-date=false
      - -Dlibmpv=true
      - -Dcplayer=false
      - -Dmanpage-build=disabled
    sources:
      - type: archive
        url: https://github.com/mpv-player/mpv/archive/v0.37.0.tar.gz
        sha256: 1d2d4adbaf048a2fa6ee134575032c4b2dad9a7efafd5b3e69b88db935afaddf
        x-checker-data:
          type: anitya
          project-id: 5348
          stable-only: true
          url-template: https://github.com/mpv-player/mpv/archive/v$version.tar.gz
    modules:
      - name: libplacebo
        buildsystem: meson
        config-opts:
          - -Dd3d11=disabled
          - -Ddemos=False
        sources:
          - type: archive
            url: https://code.videolan.org/videolan/libplacebo/-/archive/v6.338.2/libplacebo-v6.338.2.tar.gz
            sha256: d029adbe55bba8aed7aed2c48b0b66081dddfb9d42683a709342e33aa666c544
            x-checker-data:
              type: anitya
              project-id: 20101
              stable-only: true
              url-template: https://code.videolan.org/videolan/libplacebo/-/archive/v$version/libplacebo-v$version.tar.gz
          - type: archive
            url: https://github.com/pallets/markupsafe/archive/refs/tags/2.1.4.tar.gz
            sha256: 7466d12ea5056e6baa9e3148b1302a33c38964793e99e4712368a794e2dca8ff
            x-checker-data:
              type: anitya
              project-id: 3918
              stable-only: true
              url-template: https://github.com/pallets/markupsafe/archive/refs/tags/$version.tar.gz
            dest: 3rdparty/markupsafe
          - type: archive
            url: https://github.com/pallets/jinja/archive/refs/tags/3.1.3.tar.gz
            sha256: fe349bfd610cba6e688274df6eda339a60a59189cb114cd769ecde49f9a5dcbe
            x-checker-data:
              type: anitya
              project-id: 3894
              stable-only: true
              url-template: https://github.com/pallets/jinja/archive/refs/tags/$version.tar.gz
            dest: 3rdparty/jinja
          - type: archive
            url: https://github.com/Dav1dde/glad/archive/refs/tags/v2.0.4.tar.gz
            sha256: 02629644c242dcc27c58222bd2c001d5e2f3765dbbcfd796542308bddebab401
            x-checker-data:
              type: anitya
              project-id: 300234
              stable-only: true
              url-template: https://github.com/Dav1dde/glad/archive/refs/tags/v$version.tar.gz
            dest: 3rdparty/glad
        modules:
          - name: glslang
            buildsystem: cmake-ninja
            config-opts:
              - -DCMAKE_BUILD_TYPE=Release
              - -DBUILD_SHARED_LIBS=ON
            cleanup:
              - /bin
            sources:
              - type: archive
                url: https://github.com/KhronosGroup/glslang/archive/14.0.0.tar.gz
                sha256: 80bbb916a23e94ea9cbfb1acb5d1a44a7e0c9613bcf5b5947c03f2273bdc92b0
                x-checker-data:
                  type: anitya
                  project-id: 205796
                  stable-only: true
                  url-template: https://github.com/KhronosGroup/glslang/archive/$version.tar.gz
              - type: archive
                url: https://github.com/KhronosGroup/SPIRV-Tools/archive/refs/tags/sdk-1.3.261.1.tar.gz
                sha256: ead95c626ad482882a141d1aa0ce47b9453871f72c42c0b28d39c82f60a52008
                dest: External/spirv-tools
                x-checker-data:
                  type: anitya
                  stable-only: true
                  project-id: 334920
                  url-template: https://github.com/KhronosGroup/SPIRV-Tools/archive/refs/tags/sdk-$version.tar.gz
              - type: archive
                url: https://github.com/KhronosGroup/SPIRV-Headers/archive/refs/tags/sdk-1.3.261.1.tar.gz
                sha256: 32b4c6ae6a2fa9b56c2c17233c8056da47e331f76e117729925825ea3e77a739
                dest: External/spirv-tools/external/spirv-headers
                x-checker-data:
                  type: anitya
                  stable-only: true
                  project-id: 334920
                  url-template: https://github.com/KhronosGroup/SPIRV-Headers/archive/refs/tags/sdk-$version.tar.gz
      - name: libass
        config-opts:
          - --disable-static
        sources:
          - type: archive
            url: https://github.com/libass/libass/releases/download/0.17.1/libass-0.17.1.tar.xz
            sha256: f0da0bbfba476c16ae3e1cfd862256d30915911f7abaa1b16ce62ee653192784
            x-checker-data:
              type: anitya
              project-id: 1560
              stable-only: true
              url-template: https://github.com/libass/libass/releases/download/$version/libass-$version.tar.xz
      - name: libXmu
        buildsystem: autotools
        sources:
          - type: archive
            url: https://xorg.freedesktop.org/releases/individual/lib/libXmu-1.1.4.tar.xz
            sha256: 210de3ab9c3e9382572c25d17c2518a854ce6e2c62c5f8315deac7579e758244
            x-checker-data:
              type: anitya
              project-id: 1785
              stable-only: true
              url-template: https://xorg.freedesktop.org/releases/individual/lib/libXmu-$version.tar.xz
      - name: libXpresent
        buildsystem: autotools
        sources:
          - type: archive
            url: https://xorg.freedesktop.org/archive/individual/lib/libXpresent-1.0.1.tar.xz
            sha256: b964df9e5a066daa5e08d2dc82692c57ca27d00b8cc257e8e960c9f1cf26231b
            x-checker-data:
              type: anitya
              project-id: 17166
              stable-only: true
              url-template: https://xorg.freedesktop.org/archive/individual/lib/libXpresent-$version.tar.xz

  - name: miniupnpc
    buildsystem: cmake-ninja
    config-opts:
      - -DUPNPC_BUILD_STATIC=FALSE
      - -DUPNPC_BUILD_SHARED=TRUE
      - -DUPNPC_BUILD_TESTS=FALSE
      - -DUPNPC_BUILD_SAMPLE=FALSE
    sources:
      - type: archive
        sha256: 37fcd91953508c3e62d6964bb8ffbc5d47f3e13481fa54e6214fcc68704c66f1
        url: https://miniupnp.tuxfamily.org/files/miniupnpc-2.2.6.tar.gz
        x-checker-data:
          type: anitya
          project-id: 1986
          url-template: https://miniupnp.tuxfamily.org/files/miniupnpc-$version.tar.gz

  - name: lapack
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DBUILD_SHARED_LIBS=ON
      - -DBUILD_TESTING=OFF
      - -DLAPACKE=ON
      - -DCBLAS=ON
      - -DCMAKE_Fortran_COMPILER=gfortran
    sources:
      - type: archive
        url: https://github.com/Reference-LAPACK/lapack/archive/refs/tags/v3.12.0.tar.gz
        sha256: eac9570f8e0ad6f30ce4b963f4f033f0f643e7c3912fc9ee6cd99120675ad48b
        x-checker-data:
          type: anitya
          project-id: 1534
          stable-only: true
          url-template: https://github.com/Reference-LAPACK/lapack/archive/refs/tags/v$version.tar.gz

  - name: openblas
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DBUILD_SHARED_LIBS=ON
      - -DBUILD_TESTING=OFF
      - -DNO_AFFINITY=ON
      - -DUSE_OPENMP=1
      - -DNO_WARMUP=1
      - -DCORE=CORE2
      - -DNUM_THREADS=64
      - -DDYNAMIC_ARCH=ON
    sources:
      - type: archive
        url: https://github.com/xianyi/OpenBLAS/archive/v0.3.26.tar.gz
        sha256: 4e6e4f5cb14c209262e33e6816d70221a2fe49eb69eaf0a06f065598ac602c68
        x-checker-data:
          type: anitya
          project-id: 2540
          url-template: https://github.com/xianyi/OpenBLAS/archive/v$version.tar.gz

  - name: libheif
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DWITH_EXAMPLES=OFF
      - -DBUILD_TESTING=OFF
    sources:
      - type: archive
        url: https://github.com/strukturag/libheif/archive/v1.17.6/libheif-1.17.6.tar.gz
        sha256: 55bae7858bfd1679923d4a7db08ce1dcf3216667fa8f1da193a0577876b8a904
        x-checker-data:
          type: json
          url: https://api.github.com/repos/strukturag/libheif/releases/latest
          tag-query: .tag_name
          timestamp-query: .published_at
          version-query: $tag | sub("^[vV]"; "")
          url-query: '"https://github.com/strukturag/libheif/archive/\($tag)/libheif-\($version).tar.gz"'

  - python3-sources.yaml

  - name: python3-patchelf
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "patchelf" --no-build-isolation
    cleanup:
      - '*'
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/83/ec/ac383eb82792e092d8037649b382cf78a7b79c2ce4e5b861f61519b9b14e/patchelf-0.17.2.1.tar.gz
        sha256: a6eb0dd452ce4127d0d5e1eb26515e39186fa609364274bc1b0b77539cfa7031
        x-checker-data:
          name: patchelf
          type: pypi

  - name: pyside6
    buildsystem: simple
    build-options:
      append-path: /usr/lib/sdk/llvm16/bin
      prepend-ld-library-path: /usr/lib/sdk/llvm16/lib
    build-commands:
      - python setup.py install --build-type=shiboken6 --ignore-git --parallel=${FLATPAK_BUILDER_N_JOBS}
        --prefix=${FLATPAK_DEST} --root=/ --optimize=1
      - cmake -Bbuild -GNinja -DCMAKE_INSTALL_PREFIX=/app -DCMAKE_INSTALL_LIBDIR=/app/lib
        -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTS=OFF -DNO_QT_TOOLS=yes -DSHIBOKEN_PYTHON_LIBRARIES='-lpython3.11'
        -DNUMPY_INCLUDE_DIR=/app/lib/python3.11/site-packages/numpy/core/include
      - ninja -j $FLATPAK_BUILDER_N_JOBS -C build install
    cleanup:
      - /share/PySide6
    sources:
      - type: archive
        url: https://download.qt.io/official_releases/QtForPython/pyside6/PySide6-6.6.1-src/pyside-setup-everywhere-src-6.6.1.tar.xz
        sha256: 341f42483fbe58c88fa5b353eefa83ffcc4ec440bf6e87c1c7ffd278ed54d1ca
      - type: shell
        commands:
          - mkdir -p ${FLATPAK_DEST}/include/qt6tmp && cp -R /usr/include/Qt* ${FLATPAK_DEST}/include/qt6tmp # https://bugreports.qt.io/projects/PYSIDE/issues/PYSIDE-787
          - cp /usr/include/pthread.h ${FLATPAK_DEST}/include/qt6tmp/pthread.h
          - sed -i 's|--include-paths=|--include-paths=/app/include/qt6tmp:|' sources/pyside6/cmake/Macros/PySideModules.cmake
      - type: patch
        path: patches/fix-build.patch

  - name: swftools
    buildsystem: autotools
    sources:
      - type: archive
        url: http://www.swftools.org/swftools-0.9.2.tar.gz
        sha256: bf6891bfc6bf535a1a99a485478f7896ebacbe3bbf545ba551298080a26f01f1
      - type: shell
        commands:
          - rm config.sub config.guess
          - cp /usr/share/automake-*/config.{sub,guess} .
      - type: patch
        path: patches/swftools-pointer.patch
      - type: patch
        path: patches/swftools-giflib-5.1.patch
      - type: patch
        path: patches/swftools-extern.patch
      - type: patch
        path: patches/swftools-install.patch

  - name: hydrus
    buildsystem: simple
    build-commands:
      - install -Dm644 io.github.hydrusnetwork.hydrus.desktop /app/share/applications/io.github.hydrusnetwork.hydrus.desktop
      - install -Dm644 io.github.hydrusnetwork.hydrus.metainfo.xml /app/share/metainfo/io.github.hydrusnetwork.hydrus.metainfo.xml
      - install -Dm644 io.github.hydrusnetwork.hydrus.128.png /app/share/icons/hicolor/128x128/apps/io.github.hydrusnetwork.hydrus.png
      - mkdir -p /app/hydrus
      - mv * /app/hydrus/
      - rm /app/hydrus/bin/swfrender_linux
      - ln -s /app/bin/swfrender /app/hydrus/bin/swfrender_linux
      - chmod +x /app/hydrus/hydrus_client.py /app/hydrus/hydrus_server.py
      - ln -s /app/hydrus/hydrus_client.py /app/bin/hydrus_client
      - ln -s /app/hydrus/hydrus_server.py /app/bin/hydrus_server
    sources:
      - type: git
        url: https://github.com/hydrusnetwork/hydrus.git
        tag: v559
        commit: fa64d3dd9e3bdef36ea5b1595c52356ab4b819bb
#        x-checker-data:
#          type: git
#          tag-pattern: ^v([\d.]+)$
      - type: file
        path: assets/icon/io.github.hydrusnetwork.hydrus.128.png
      - type: file
        path: assets/io.github.hydrusnetwork.hydrus.desktop
      - type: file
        path: assets/io.github.hydrusnetwork.hydrus.metainfo.xml
